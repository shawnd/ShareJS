#!/usr/bin/env node

var forever = require('forever-monitor');
var fs = require('fs');
var argv = require('optimist').
    usage("Usage: $0 -f options.js").
	demand('f').
    alias('f','options').
	argv;

options = require(argv.options);

var child = new (forever.Monitor)('/usr/bin/sharejs', {
  pidFile: '/var/run/sharejs.pid',
  killTree: 'true',
  options: ['-f', options.sharejs_options_file],
});

var notify_runtime = function(){
  fs.writeFile(options.daemon_pulse_file, Date().toString(), function (err){
    if(err){
      process.exit();
    }
  });
};

child.on('stop', function(){
    fs.unlinkSync(options.daemon_pulse_file);
});
child.on('restart', notify_runtime);

process.on('exit', function(){
    fs.unlinkSync(options.daemon_pulse_file);
});

notify_runtime();
child.start();
