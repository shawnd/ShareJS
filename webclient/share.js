(function(){var t,e,n,o,i,s,r,c,h,l,p,u,a,d,f,g,v,m,y,b,w,k,O=[].slice,_=function(t,e){return function(){return t.apply(e,arguments)}},E=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};window.sharejs=u={version:"0.6.3"},"undefined"==typeof WEB&&(window.WEB=!0),g="undefined"!=typeof WEB&&null!==WEB?function(t){return setTimeout(t,0)}:process.nextTick,o=function(){function t(){}return t.prototype.on=function(t,e){var n;return this._events||(this._events={}),(n=this._events)[t]||(n[t]=[]),this._events[t].push(e),this},t.prototype.removeListener=function(t,e){var n,o,i,s=this;for(this._events||(this._events={}),o=(i=this._events)[t]||(i[t]=[]),n=0;n<o.length;)o[n]===e&&(o[n]=void 0),n++;return g(function(){var e;return s._events[t]=function(){var n,o,i,s;for(i=this._events[t],s=[],n=0,o=i.length;o>n;n++)e=i[n],e&&s.push(e);return s}.call(s)}),this},t.prototype.emit=function(){var t,e,n,o,i,s,r;if(e=arguments[0],t=2<=arguments.length?O.call(arguments,1):[],!(null!=(s=this._events)?s[e]:void 0))return this;for(r=this._events[e],o=0,i=r.length;i>o;o++)n=r[o],n&&n.apply(this,t);return this},t.prototype.once=function(t,e){var n,o=this;return this.on(t,n=function(){var i;return i=1<=arguments.length?O.call(arguments,0):[],o.removeListener(t,n),e.apply(o,i)})},t}(),o.mixin=function(t){var e;return e=t.prototype||t,e.on=o.prototype.on,e.removeListener=o.prototype.removeListener,e.emit=o.prototype.emit,e.once=o.prototype.once,t},"undefined"!=typeof WEB&&null!==WEB||(module.exports=o),u._bt=h=function(t,e,n,o){var i,s;return i=function(t,n,o,i){return e(o,t,n,"left"),e(i,n,t,"right")},t.transformX=t.transformX=s=function(t,e){var r,c,h,l,p,u,a,d,f,g,v,m,y,b,w,k,O,_,E;for(n(t),n(e),p=[],g=0,b=e.length;b>g;g++){for(f=e[g],l=[],r=0;r<t.length;){if(u=[],i(t[r],f,l,u),r++,1!==u.length){if(0===u.length){for(_=t.slice(r),v=0,w=_.length;w>v;v++)c=_[v],o(l,c);f=null;break}for(E=s(t.slice(r),u),h=E[0],d=E[1],m=0,k=h.length;k>m;m++)c=h[m],o(l,c);for(y=0,O=d.length;O>y;y++)a=d[y],o(p,a);f=null;break}f=u[0]}null!=f&&o(p,f),t=l}return[t,p]},t.transform=t.transform=function(t,n,o){var i,r,c,h,l;if("left"!==o&&"right"!==o)throw new Error("type must be 'left' or 'right'");return 0===n.length?t:1===t.length&&1===n.length?e([],t[0],n[0],o):"left"===o?(h=s(t,n),i=h[0],c=h[1],i):(l=s(n,t),c=l[0],r=l[1],r)}},"undefined"==typeof WEB&&(u.bootstrapTransform=h),y={},y.name="text",y.create=function(){return""},m=function(t,e,n){return t.slice(0,e)+n+t.slice(e)},l=function(t){var e,n;if("number"!=typeof t.p)throw new Error("component missing position field");if(n=typeof t.i,e=typeof t.d,!("string"===n^"string"===e))throw new Error("component needs an i or d field");if(!(t.p>=0))throw new Error("position cannot be negative")},p=function(t){var e,n,o;for(n=0,o=t.length;o>n;n++)e=t[n],l(e);return!0},y.apply=function(t,e){var n,o,i,s;for(p(e),i=0,s=e.length;s>i;i++)if(n=e[i],null!=n.i)t=m(t,n.p,n.i);else{if(o=t.slice(n.p,n.p+n.d.length),n.d!==o)throw new Error("Delete component '"+n.d+"' does not match deleted text '"+o+"'");t=t.slice(0,n.p)+t.slice(n.p+n.d.length)}return t},y._append=c=function(t,e){var n,o,i;if(""!==e.i&&""!==e.d)return 0===t.length?t.push(e):(n=t[t.length-1],null!=n.i&&null!=e.i&&n.p<=(o=e.p)&&o<=n.p+n.i.length?t[t.length-1]={i:m(n.i,e.p-n.p,e.i),p:n.p}:null!=n.d&&null!=e.d&&e.p<=(i=n.p)&&i<=e.p+e.d.length?t[t.length-1]={d:m(e.d,n.p-e.p,n.d),p:e.p}:t.push(e))},y.compose=function(t,e){var n,o,i,s;for(p(t),p(e),o=t.slice(),i=0,s=e.length;s>i;i++)n=e[i],c(o,n);return o},y.compress=function(t){return y.compose([],t)},y.normalize=function(t){var e,n,o,i;for(n=[],null==t.i&&null==t.p||(t=[t]),o=0,i=t.length;i>o;o++)e=t[o],null==e.p&&(e.p=0),c(n,e);return n},w=function(t,e,n){return null!=e.i?e.p<t||e.p===t&&n?t+e.i.length:t:t<=e.p?t:t<=e.p+e.d.length?e.p:t-e.d.length},y.transformCursor=function(t,e,n){var o,i,s,r;for(i="right"===n,s=0,r=e.length;r>s;s++)o=e[s],t=w(t,o,i);return t},y._tc=b=function(t,e,n,o){var i,s,r,h,l,u;if(p([e]),p([n]),null!=e.i)c(t,{i:e.i,p:w(e.p,n,"right"===o)});else if(null!=n.i)u=e.d,e.p<n.p&&(c(t,{d:u.slice(0,n.p-e.p),p:e.p}),u=u.slice(n.p-e.p)),""!==u&&c(t,{d:u,p:e.p+n.i.length});else if(e.p>=n.p+n.d.length)c(t,{d:e.d,p:e.p-n.d.length});else if(e.p+e.d.length<=n.p)c(t,e);else{if(h={d:"",p:e.p},e.p<n.p&&(h.d=e.d.slice(0,n.p-e.p)),e.p+e.d.length>n.p+n.d.length&&(h.d+=e.d.slice(n.p+n.d.length-e.p)),r=Math.max(e.p,n.p),s=Math.min(e.p+e.d.length,n.p+n.d.length),i=e.d.slice(r-e.p,s-e.p),l=n.d.slice(r-n.p,s-n.p),i!==l)throw new Error("Delete ops delete different text in the same region of the document");""!==h.d&&(h.p=w(h.p,n),c(t,h))}return t},f=function(t){return null!=t.i?{d:t.i,p:t.p}:{i:t.d,p:t.p}},y.invert=function(t){var e,n,o,i,s;for(i=t.slice().reverse(),s=[],n=0,o=i.length;o>n;n++)e=i[n],s.push(f(e));return s},"undefined"!=typeof WEB&&null!==WEB?(u.types||(u.types={}),h(y,b,p,c),u.types.text=y):(module.exports=y,require("./helpers").bootstrapTransform(y,b,p,c)),"undefined"==typeof WEB&&(y=require("./text")),y.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(t,e,n){var o;return o=[{p:t,i:e}],this.submitOp(o,n),o},del:function(t,e,n){var o;return o=[{p:t,d:this.snapshot.slice(t,t+e)}],this.submitOp(o,n),o},_register:function(){return this.on("remoteop",function(t){var e,n,o,i;for(i=[],n=0,o=t.length;o>n;n++)e=t[n],void 0!==e.i?i.push(this.emit("insert",e.p,e.i)):i.push(this.emit("delete",e.p,e.d));return i})}},"undefined"!=typeof WEB&&null!==WEB||(k=require("../types")),"undefined"!=typeof WEB&&null!==WEB&&(u.extendDoc=function(t,e){return n.prototype[t]=e}),n=function(){function t(t,e,n){this.connection=t,this.name=e,this.shout=_(this.shout,this),this.flush=_(this.flush,this),n||(n={}),this.version=n.v,this.snapshot=n.snapshot,n.type&&this._setType(n.type),this.state="closed",this.autoOpen=!1,this._create=n.create,this.inflightOp=null,this.inflightCallbacks=[],this.inflightSubmittedIds=[],this.pendingOp=null,this.pendingCallbacks=[],this.serverOps={}}return t.prototype._xf=function(t,e){var n,o;return this.type.transformX?this.type.transformX(t,e):(n=this.type.transform(t,e,"left"),o=this.type.transform(e,t,"right"),[n,o])},t.prototype._otApply=function(t,e){var n;return n=this.snapshot,this.snapshot=this.type.apply(this.snapshot,t),this.emit("change",t,n,e),e?this.emit("remoteop",t,n):void 0},t.prototype._connectionStateChanged=function(t,e){switch(t){case"disconnected":this.state="closed",this.inflightOp&&this.inflightSubmittedIds.push(this.connection.id),this.emit("closed");break;case"ok":this.autoOpen&&this.open();break;case"stopped":"function"==typeof this._openCallback&&this._openCallback(e)}return this.emit(t,e)},t.prototype._setType=function(t){var e,n,o;if(!this.type){if("string"==typeof t&&(t=k[t]),!t||!t.compose)throw new Error("Support for types without compose() is not implemented");if(this.type=t,t.api){o=t.api;for(e in o)n=o[e],this[e]=n;return"function"==typeof this._register?this._register():void 0}return this.provides={}}},t.prototype._onMessage=function(t){var e,n,o,i,s,r,c,h,l,p,u,a,d,f,g,v,m,y,b,w;switch(!1){case t.open!==!0:return this.state="open",this._create=!1,null==this.created&&(this.created=!!t.create),t.type&&this._setType(t.type),t.create?(this.created=!0,this.snapshot=this.type.create()):(this.created!==!0&&(this.created=!1),void 0!==t.snapshot&&(this.snapshot=t.snapshot)),t.meta&&(this.meta=t.meta),null!=t.v&&(this.version=t.v),this.inflightOp?(c={doc:this.name,op:this.inflightOp,v:this.version},this.inflightSubmittedIds.length&&(c.dupIfSource=this.inflightSubmittedIds),this.connection.send(c)):this.flush(),this.emit("open"),"function"==typeof this._openCallback?this._openCallback(null):void 0;case t.open!==!1:return t.error&&("undefined"!=typeof console&&null!==console&&console.error("Could not open document: "+t.error),this.emit("error",t.error),"function"==typeof this._openCallback&&this._openCallback(t.error)),this.state="closed",this.emit("closed"),"function"==typeof this._closeCallback&&this._closeCallback(),this._closeCallback=null;case!(null===t.op&&"Op already submitted"===o):break;case!(void 0===t.op&&void 0!==t.v||t.op&&(f=t.meta.source,E.call(this.inflightSubmittedIds,f)>=0)):if(i=this.inflightOp,this.inflightOp=null,this.inflightSubmittedIds.length=0,o=t.error)for(this.type.invert?(h=this.type.invert(i),this.pendingOp&&(g=this._xf(this.pendingOp,h),this.pendingOp=g[0],h=g[1]),this._otApply(h,!0)):this.emit("error","Op apply failed ("+o+") and the op could not be reverted"),v=this.inflightCallbacks,p=0,a=v.length;a>p;p++)(e=v[p])(o);else{if(t.v!==this.version)throw new Error("Invalid version from server");for(this.serverOps[this.version]=i,this.version++,this.emit("acknowledge",i),m=this.inflightCallbacks,u=0,d=m.length;d>u;u++)(e=m[u])(null,i)}return this.flush();case!t.op:if(t.v<this.version)return;return t.doc!==this.name?this.emit("error","Expected docName '"+this.name+"' but got "+t.doc):t.v!==this.version?this.emit("error","Expected version "+this.version+" but got "+t.v):(s=t.op,this.serverOps[this.version]=s,n=s,null!==this.inflightOp&&(y=this._xf(this.inflightOp,n),this.inflightOp=y[0],n=y[1]),null!==this.pendingOp&&(b=this._xf(this.pendingOp,n),this.pendingOp=b[0],n=b[1]),this.version++,this._otApply(n,!0));case!t.meta:switch(w=t.meta,r=w.path,l=w.value,null!=r?r[0]:void 0){case"shout":return this.emit("shout",l);default:return"undefined"!=typeof console&&null!==console?console.warn("Unhandled meta op:",t):void 0}break;default:return"undefined"!=typeof console&&null!==console?console.warn("Unhandled document message:",t):void 0}},t.prototype.flush=function(){return"ok"===this.connection.state&&null===this.inflightOp&&null!==this.pendingOp?(this.inflightOp=this.pendingOp,this.inflightCallbacks=this.pendingCallbacks,this.pendingOp=null,this.pendingCallbacks=[],this.connection.send({doc:this.name,op:this.inflightOp,v:this.version})):void 0},t.prototype.submitOp=function(t,e){return null!=this.type.normalize&&(t=this.type.normalize(t)),this.snapshot=this.type.apply(this.snapshot,t),null!==this.pendingOp?this.pendingOp=this.type.compose(this.pendingOp,t):this.pendingOp=t,e&&this.pendingCallbacks.push(e),this.emit("change",t),setTimeout(this.flush,0)},t.prototype.shout=function(t){return this.connection.send({doc:this.name,meta:{path:["shout"],value:t}})},t.prototype.open=function(t){var e,n=this;return this.autoOpen=!0,"closed"===this.state?(e={doc:this.name,open:!0},void 0===this.snapshot&&(e.snapshot=null),this.type&&(e.type=this.type.name),null!=this.version&&(e.v=this.version),this._create&&(e.create=!0),this.connection.send(e),this.state="opening",this._openCallback=function(e){return n._openCallback=null,"function"==typeof t?t(e):void 0}):void 0},t.prototype.close=function(t){return this.autoOpen=!1,"closed"===this.state?"function"==typeof t?t():void 0:(this.connection.send({doc:this.name,open:!1}),this.state="closed",this.emit("closing"),this._closeCallback=t)},t}(),"undefined"!=typeof WEB&&null!==WEB||(o=require("./microevent")),o.mixin(n),u.Doc=n,i=function(){function t(t,e,n){var o,i,s=this;null!=e&&"function"==typeof e?(n=e,e=void 0):"function"!=typeof n&&(n=r),this.debug=this.debugAll,this.reconnectInterval=1e3,this.timeoutInterval=2e3,this.forcedClose=!1,this.url=t,this.protocols=e,this.readyState=n.CONNECTING,this.URL=t,i=!1,(o=function(t){var e;return s.ws=new n(s.url),s.debug&&console.debug("ReconnectingWebSocket","attempt-connect",s.url),e=setTimeout(function(){return s.debug&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),i=!0,s.ws.close(),i=!1},s.timeoutInterval),s.ws.onopen=function(o){return clearTimeout(e),s.debug&&console.debug("ReconnectingWebSocket","onopen",s.url),s.readyState=n.OPEN,t=!1,s.onopen(o)},s.ws.onclose=function(r){return clearTimeout(e),s.ws=null,s.forcedClose?(s.readyState=n.CLOSED,s.onclose(r)):(s.readyState=n.CONNECTING,s.onconnecting(r),t||i||(s.debug&&console.debug("ReconnectingWebSocket","onclose",s.url),s.onclose(r)),setTimeout(function(){return o(!0)},s.reconnectInterval))},s.ws.onmessage=function(t){return s.debug&&console.debug("ReconnectingWebSocket","onmessage",s.url,t.data),s.onmessage(t)},s.ws.onerror=function(t){return s.debug&&console.debug("ReconnectingWebSocket","onerror",s.url,t),s.onerror(t)}})(this.url)}return t.prototype.onopen=function(t){},t.prototype.onclose=function(t){},t.prototype.onconnecting=function(t){},t.prototype.onmessage=function(t){},t.prototype.onerror=function(t){},t.prototype.send=function(t){if(this.ws)return this.debug&&console.debug("ReconnectingWebSocket","send",this.url,t),this.ws.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},t.prototype.close=function(){return this.ws?(this.forcedClose=!0,this.ws.close()):void 0},t.prototype.debugAll=!1,t.prototype.refresh=function(){return this.ws?this.ws.close():void 0},t}(),"undefined"!=typeof WEB&&null!==WEB?(k=u.types,t=window.BCSocket,s=window.SockJS,r=window.WebSocket,v=t?"channel":s?"sockjs":"websocket"):(k=require("../types"),t=require("browserchannel").BCSocket,n=require("./doc").Doc,r=require("ws"),v=null),e=function(){function e(e,n,o){var r=this;this.docs={},this.state="connecting",null==v&&e.match(/^ws:/)&&(v="websocket");var c={reconnect:!0};o&&(c.extraParams={shardId:o}),this.socket=function(){switch(v){case"channel":return new t(e,c);case"sockjs":return new i(e,s);case"websocket":return new i(e);default:return new t(e,c)}}(),this.socket.onmessage=function(t){var e;return"sockjs"!==v&&"websocket"!==v||(t=JSON.parse(t.data)),null===t.auth?(r.lastError=t.error,r.disconnect(),r.emit("connect failed",t.error)):t.auth?(r.id=t.auth,void r.setState("ok")):(e=t.doc,void 0!==e?r.lastReceivedDoc=e:t.doc=e=r.lastReceivedDoc,r.docs[e]?r.docs[e]._onMessage(t):"undefined"!=typeof console&&null!==console?console.error("Unhandled message",t):void 0)},this.connected=!1,this.socket.onclose=function(t){return r.setState("disconnected",t),"Closed"===t||"Stopped by server"===t?r.setState("stopped",r.lastError||t):void 0},this.socket.onerror=function(t){return r.emit("error",t)},this.socket.onopen=function(){return r.send({auth:n?n:null}),r.lastError=r.lastReceivedDoc=r.lastSentDoc=null,r.setState("handshaking")},this.socket.onconnecting=function(){return r.setState("connecting")}}return e.prototype.setState=function(t,e){var n,o,i,s;if(this.state!==t){this.state=t,"disconnected"===t&&delete this.id,this.emit(t,e),i=this.docs,s=[];for(o in i)n=i[o],s.push(n._connectionStateChanged(t,e));return s}},e.prototype.send=function(t){var e;return t.doc&&(e=t.doc,e===this.lastSentDoc?delete t.doc:this.lastSentDoc=e),"sockjs"!==v&&"websocket"!==v||(t=JSON.stringify(t)),this.socket.send(t)},e.prototype.disconnect=function(){return this.socket.close()},e.prototype.makeDoc=function(t,e,o){var i,s=this;if(this.docs[t])throw new Error("Doc "+t+" already open");return i=new n(this,t,e),this.docs[t]=i,i.open(function(e){return e&&delete s.docs[t],e||i.on("closed",function(){return i.autoOpen?void 0:delete s.docs[t]}),o(e,e?void 0:i)})},e.prototype.openExisting=function(t,e){var n;return"stopped"===this.state?e("connection closed"):this.docs[t]?this._ensureOpenState(this.docs[t],e):n=this.makeDoc(t,{},e)},e.prototype.open=function(t,e,n){var o;if("stopped"===this.state)return n("connection closed");if("connecting"===this.state)return void this.on("handshaking",function(){return this.open(t,e,n),n=null});if("function"==typeof e&&(n=e,e="text"),n||(n=function(){}),"string"==typeof e&&(e=k[e]),!e)throw new Error("OT code for document type missing");if(null==t)throw new Error("Server-generated random doc names are not currently supported");return this.docs[t]?(o=this.docs[t],void(o.type===e?this._ensureOpenState(o,n):n("Type mismatch",o))):this.makeDoc(t,{create:!0,type:e.name},n)},e.prototype._ensureOpenState=function(t,e){switch(t.state){case"open":e(null,t);break;case"opening":this.on("open",function(){return e(null,t)});break;case"closed":t.open(function(n){return e(n,n?void 0:t)})}},e}(),"undefined"!=typeof WEB&&null!==WEB||(o=require("./microevent")),o.mixin(e),u.Connection=e,"undefined"!=typeof WEB&&null!==WEB?(a=void 0!==window.BCSocket,d=void 0!==window.SockJS,v=a?"channel":d?"sockjs":"websocket"):e=require("./connection").Connection,u.open=function(){var t,n,o;return t={},n=function(n,o){var i,s,r,c;return"undefined"!=typeof WEB&&null!==WEB&&null==n&&(r=window.location,c="websocket"===v?"ws:":r.protocol,n=""+c+"//"+r.host+"/"+v),t[n]||(i=new e(n,o),s=function(){return delete t[n]},i.on("disconnected",s),i.on("connect failed",s),t[n]=i),t[n]},o=function(t){var e,n,o,i;o=0,i=t.docs;for(n in i)e=i[n],("closed"!==e.state||e.autoOpen)&&o++;return 0===o?t.disconnect():void 0},function(t,e,i,s){var r,c,h;return"function"==typeof i&&(s=i,i={}),"string"==typeof i&&(i={origin:i}),h=i.origin,r=i.authentication,c=n(h,r),c.open(t,e,function(t,e){return t?(s(t),o(c)):(e.on("closed",function(){return o(c)}),s(null,e))}),c.on("connect failed"),c}}(),"undefined"!=typeof WEB&&null!==WEB||(u.Doc=require("./doc").Doc,u.Connection=require("./connection").Connection)}).call(this);